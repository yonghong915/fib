<?xml version="1.0" encoding="UTF-8" ?>
<message-bean-mapping id="BEPS_723MappingOut" source-type="message-bean" target-type="map">
	<!--验签结果-->
	<mapping type="value-mapping" from="checkEscortFlag" to="checkEscortFlag"/> <!--核押验签结果 -->
	<!-- 报文头 begin -->
	<mapping type="value-mapping" from="MsgHeader.BeginFlag" to="extendMap.beginFlag"></mapping><!-- 开始标识 -->
	<mapping type="value-mapping" from="MsgHeader.VersionID" to="extendMap.versionID"></mapping><!-- 版本号 -->
	<mapping type="value-mapping" from="MsgHeader.OrigSender" to="extendMap.origSender"></mapping><!-- 报文发起人，14位 不足则后补空格 -->
	<mapping type="value-mapping" from="MsgHeader.OrigSenderSID" to="prodCatalogId"></mapping><!-- 发送系统号  BEPS-->
	<!-- 为适应于平台990回执报文，在extendMap中添加字段origSenderSID -->
	<mapping type="value-mapping" from="MsgHeader.OrigSenderSID" to="extendMap.origSenderSID"></mapping>

	<mapping type="value-mapping" from="MsgHeader.OrigReceiver" to="extendMap.origReceiver"></mapping><!-- 报文接收人 -->
	<mapping type="value-mapping" from="MsgHeader.OrigReceiverSID" to="extendMap.origReceiverSID"></mapping><!-- 接收系统号 BEPS-->
	<mapping type="value-mapping" from="MsgHeader.OrigSendDate" to="extendMap.origSendDate" ></mapping><!-- 报文发起日期20100501 -->
	<mapping type="value-mapping" from="MsgHeader.OrigSendTime" to="extendMap.origSendTime"></mapping><!-- 报文发起时间094508-->
	<mapping type="value-mapping" from="MsgHeader.StructType" to="extendMap.structType"></mapping><!-- 报文格式 -->
	<mapping type="value-mapping" from="MsgHeader.MesgType" to="contentMimeTypeId"></mapping><!-- 报文类型代码beps.008.001.01-->
	<mapping type="value-mapping" from="MsgHeader.MesgID" to="extendMap.mesgID" ></mapping><!-- 通信级标志号 -->
	<mapping type="value-mapping" from="MsgHeader.MesgRefID" to="extendMap.mesgRefID" ></mapping><!-- 通信级参考号00000000000000000000 -->
  	<mapping type="value-mapping" from="MsgHeader.MesgPriority" to="extendMap.mesgPriority"></mapping><!-- 报文优先级-->
	<mapping type="value-mapping" from="MsgHeader.MesgDirection" to="extendMap.mesgDirection"></mapping><!--报文传输方向 -->
    <mapping type="value-mapping" from="MsgHeader.Reserve" to="extendMap.reserve"></mapping><!--保留域-->
	<mapping type="value-mapping" from="MsgHeader.EndFlag" to="extendMap.endFlag"></mapping><!-- 结束标识 -->
    <!-- 报文头 end-->

	<!-- 报文体内容 -->
	<!-- 业务头 -->
	<mapping type="value-mapping" from="BEPS_723_Out.GrpHdr.MessageIdentification" to="subject" /><!--报文标识号  -->
	<mapping type="value-mapping" from="BEPS_723_Out.GrpHdr.CreationDateTime" to="extendMap.creationDateTime"/><!-- 报文发送时间 -->
	<mapping type="value-mapping" from="BEPS_723_Out.GrpHdr.InstructingDirectParty" to="extendMap.instructingDirectParty"/><!-- 发起直接参与机构-->
	<mapping type="value-mapping" from="BEPS_723_Out.GrpHdr.InstructingParty" to="partyIdFrom"/><!-- 发起参与机构  -->
	<mapping type="value-mapping" from="BEPS_723_Out.GrpHdr.InstructedDirectParty" to="extendMap.instructedDirectParty"/><!-- 接收直接参与机构  -->
	<mapping type="value-mapping" from="BEPS_723_Out.GrpHdr.InstructedParty" to="InstructedParty"/><!-- 接收参与机构  -->
	<mapping type="value-mapping" from="BEPS_723_Out.GrpHdr.SystemCode" to="extendMap.systemCode"/><!-- 系统编号 -->
	<mapping type="value-mapping" from="BEPS_723_Out.GrpHdr.Remark" to="extendMap.remark"/><!-- 备注 -->

	<!-- 报文分片组件 -->
	<!-- <mapping type="value-mapping" from="BEPS_723_Out.Prttn.TotalNumber" to="TotalNumber"/> 总记录数 -->
	<!-- <mapping type="value-mapping" from="BEPS_723_Out.Prttn.StartNumber" to="StartNumber"/>本报文记录起始序号 -->
	<!-- <mapping type="value-mapping" from="BEPS_723_Out.Prttn.EndNumber" to="EndNumber"/>本报文记录截止序号 -->


	<!-- 原报文主键 -->
	<mapping type="value-mapping" from="BEPS_723_Out.OrgnlGrpHdr.OriginalMessageIdentification" to="extendMap.originalMessageIdentification"/><!-- 原报文标识号 -->
	<mapping type="value-mapping" from="BEPS_723_Out.OrgnlGrpHdr.OriginalInstructingParty" to="extendMap.originalInstructingParty"/><!-- 原发起参与机构 -->
	<mapping type="value-mapping" from="BEPS_723_Out.OrgnlGrpHdr.OriginalMessageType" to="extendMap.originalMessageType"/><!-- 原报文类型-->

	<!-- 其他 -->
	<mapping type="value-mapping" from="BEPS_723_Out.CheckDate" to="extendMap.checkDate"></mapping><!-- 对账日期 -->

	<!-- NPC信息组件 -->
	<mapping type="value-mapping" from="BEPS_723_Out.NPCPrcInf.ProcessStatus" to="extendMap.ProcessStatus"/><!-- NPC处理状态 -->
	<mapping type="value-mapping" from="BEPS_723_Out.NPCPrcInf.ProcessCode" to="extendMap.NPC.ProcessCode"/><!-- NPC处理码 -->
	<mapping type="value-mapping" from="BEPS_723_Out.NPCPrcInf.RejectInformation" to="extendMap.RejectInformation"/><!-- NPC拒绝信息 -->
	<mapping type="value-mapping" from="BEPS_723_Out.NPCPrcInf.NettingDate" to="extendMap.NPC.NettingDate"/><!-- NPC轧差日期 -->
	<mapping type="value-mapping" from="BEPS_723_Out.NPCPrcInf.NettingRound" to="extendMap.NPC.NettingRound"/><!-- NPC轧差场次 -->
	<mapping type="value-mapping" from="BEPS_723_Out.NPCPrcInf.SettlementDate" to="extendMap.NPC.SettlementDate"/><!-- NPC清算日期/终态日期 -->
	<mapping type="value-mapping" from="BEPS_723_Out.NPCPrcInf.ReceiveTime" to="extendMap.NPC.ReceiveTime"/><!-- NPC接收时间 -->
	<mapping type="value-mapping" from="BEPS_723_Out.NPCPrcInf.TransmitTime" to="extendMap.NPC.TransmitTime"/><!-- NPC转发时间 -->
	<!-- endNPC -->

	<mapping type="value-mapping" from="BEPS_723_Out.NumberOfTransactions" to="extendMap.NumberOfTransactions"></mapping><!-- 应答明细数目 -->
	<mapping type="value-mapping" from="BEPS_723_Out.NumberOfTransactions2" to="NumberOfTransactions2"></mapping><!-- 应答明细数目 -->

	<mapping type="value" to="productId">ACCTCHCK_BEPS_DTL</mapping>
	<mapping type="value" to="communicationEventTypeId">MESSAGE_IN_COMM</mapping>
	<mapping type="value" to="extendMap.requestOrResponse">response</mapping>
	<mapping type="value" to="serviceId">processCommunicationEvent</mapping>

		<manual-mapping> <![CDATA[

			import com.giantstone.security.TccrbSignature;   //包名
			import com.giantstone.tcrcb.util.CommUtils;
			import com.giantstone.cnaps2.messagebean.recv.req.*;
			import java.util.List;
			import java.util.ArrayList;
			import java.util.HashMap;
			import java.lang.Integer;
			import java.lang.Long;
			import java.math.BigDecimal;

			Map extendMap = target.get("extendMap");
			extendMap.put("dataTypeId","DT1002");

			List AcctChckSum = new ArrayList();
			String  TotalNumber = sourceBean.BEPS_723_Out.Prttn.TotalNumber;
			String  startNb = sourceBean.BEPS_723_Out.Prttn.StartNumber;
			String  endNb = sourceBean.BEPS_723_Out.Prttn.EndNumber;
			if(TotalNumber==null||TotalNumber.length()==0){
					TotalNumber = "0";
				}
				if(startNb==null||startNb.length()==0){
					startNb = "0";
				}
				if(endNb==null||endNb.length()==0){
					endNb = "0";
				}
				
				int start = Integer.parseInt(startNb);
				int end = Integer.parseInt(endNb);
				int pageNb = end - start + 1 ;
				if(start==0&&end==0){
					pageNb = 0;
				}
				Long prttnTtlNb = Long.valueOf(TotalNumber);
				Long prttnRcvNb = Long.valueOf(String.valueOf(pageNb));
				extendMap.put("prttnTtlNb",prttnTtlNb);
				extendMap.put("prttnRcvNb",prttnRcvNb);

			List beps = sourceBean.BEPS_723_Out.ccti;
			for(BEPS_723_OutCcti map : beps){
				String SendReceiveType = map.SendReceiveType;
				String TransactionNettingDate = map.TransactionNettingDate;
				String TransactionNettingRound = map.TransactionNettingRound;
				String MessageType = map.MessageType;
				String ProcessStatus = map.ProcessStatus;
				String NumberOfDetails = map.NumberOfDetails;

				Map Sum = new HashMap();
				Sum.put("mT", MessageType);
				Sum.put("txNetgDt", TransactionNettingDate);
				
				// 非“已清算”类的轧差场次为一个0
				if("PR04".equals(ProcessStatus)){
					Sum.put("txNetgRnd", TransactionNettingRound);
				} else {
					Sum.put("txNetgRnd", "0");
				}
				
				Sum.put("prcSts", ProcessStatus);
				Sum.put("sndRcvTp", SendReceiveType);
				Sum.put("dimTypeId","DIMT201");
				Long nb = Long.valueOf(NumberOfDetails);
				Sum.put("nb", nb);
				int i = 0;
				List AcctChckDetails = new ArrayList();
				List beps2 = map.ccti_01;
				for(BEPS_723_OutCctiCcti_01 map2 : beps2){
					String OriginalMessageIdentification2 = map2.OrgnlGrpHdr2.OriginalMessageIdentification;
					String OriginalInstructingParty2 = map2.OrgnlGrpHdr2.OriginalInstructingParty;
					String OriginalMessageType2 = map2.OrgnlGrpHdr2.OriginalMessageType;

					String TotalCount = map2.TotalCount;
					String CurrencyType = map2.CurrencyType;
					String ControlSum = map2.ControlSum;

					Map temp = new HashMap();
					temp.put("transId",OriginalMessageIdentification2+":"+OriginalInstructingParty2+":"+OriginalMessageType2);
					BigDecimal amt = new BigDecimal(ControlSum);
					temp.put("amt",amt);
					temp.put("ccy",CurrencyType);
					temp.put("detailsTypeId","DTLT2001");
					temp.put("prcSts", ProcessStatus);
					temp.put("ttlCnt", TotalCount);
					AcctChckDetails.add(temp);

					if(i==0){
						if("RMB".equals(CurrencyType)){
							Sum.put("ccy", "CNY");
						} else {
							Sum.put("ccy", CurrencyType);
						}
						i++;
					}
				}
				Sum.put("AcctChckDetails",AcctChckDetails);
				AcctChckSum.add(Sum);
			}

		List beps3 = sourceBean.BEPS_723_Out.ccti2;
		for(BEPS_723_OutCcti2 map3 : beps3){
			String SendReceiveType2 = map3.SendReceiveType2;
			String MessageType2 = map3.MessageType2;
			String ReceiveDate = map3.ReceiveDate;
			String NumberOfDetails2 = map3.NumberOfDetails2;
			Map Sum = new HashMap();
				Sum.put("mT", MessageType2);
				Sum.put("sndRcvTp", SendReceiveType2);
				Long nb = Long.valueOf(NumberOfDetails2);
				Sum.put("nb", nb);
				Sum.put("rcvDt", ReceiveDate);
				Sum.put("dimTypeId","DIMT202");
				List AcctChckDetails = new ArrayList();
				List beps4 = map3.ccti2_01;
				for(BEPS_723_OutCcti2Ccti2_01 map4 : beps4){
					String OriginalMessageIdentification3 = map4.OrgnlGrpHdr3.OriginalMessageIdentification;
					String OriginalInstructingParty3 = map4.OrgnlGrpHdr3.OriginalInstructingParty;
					String OriginalMessageType3 = map4.OrgnlGrpHdr3.OriginalMessageType;
					String ProcessStatus2 = map4.ProcessStatus2;
					String PaymentIdentification = map4.PaymentIdentification;
					Map temp = new HashMap();
					temp.put("transId",OriginalMessageIdentification3+":"+OriginalInstructingParty3+":"+OriginalMessageType3);
					temp.put("detailsTypeId","DTLT2002");
					temp.put("prcSts", ProcessStatus2);
					temp.put("pmtId", PaymentIdentification);
					AcctChckDetails.add(temp);
					}
				Sum.put("AcctChckDetails",AcctChckDetails);
				AcctChckSum.add(Sum);
			}

			extendMap.put("AcctChckSum",AcctChckSum);

			]]> </manual-mapping>
  </message-bean-mapping>
