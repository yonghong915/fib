<?xml version="1.0" encoding="UTF-8"?>
<message-bean-mapping id="HVPS_112MappingOut" source-type="message-bean" target-type="map">
 <!--来账登记交流事件要素-->
  	<mapping type="value" to="serviceId">processPaymentOrder</mapping>
	<mapping type="value-mapping" from="checkEscortFlag" to="checkEscortFlag"/> <!--核押验签结果 -->
	<!--来账登记交流事件要素-->
	<mapping type="value" to="salesChannelEnumId">CNAPS</mapping><!--触发ECA条件-->
	<mapping type="value-mapping" from="HVPS_112_Out.MessageIdentification" to="externalId"></mapping><!--报文标识号-->
	<mapping type="value-mapping" from="MsgHeader.MesgType" to="contentMimeTypeId"></mapping><!--报文类型号-->
	<mapping type="value" to="paymentMethodInfo.paymentMethodTypeId">EXT_CNAPS</mapping>
	<mapping type="value" to="paymentMethodInfo.paymentMethodId">10001</mapping>
	<mapping type="value" to="disbursement.voucherType">99</mapping>
	<mapping type="value" to="cashOrTallyFlag">1</mapping><!--现转标识-->
	<!-- 行内经过人行转发，区分来往-->
	<mapping type="value" to="communicationEventTypeId">MESSAGE_IN_COMM</mapping><!-- 来账标识-->
	<!-- 人工认证号-->
    <mapping type="value-mapping" to="paymentMethodInfo.manualRefNum" from="HVPS_112_Out.MessageIdentification"></mapping>

	<mapping type="value-mapping" from="HVPS_112_Out.InterbankSettlementAmount" to="disbursement.maxAmount"></mapping>
 <mapping type="value-mapping" from="HVPS_112_Out.InterbankSettlementAmount" to="paymentMethodInfo.maxAmount"></mapping>
	<mapping type="value-mapping" from="HVPS_112_Out.Identification2" to="InstructedParty"></mapping>
	 <!--与平台约定，将报文类型传入answers，方便该业务退汇时确认报文类型-->
	<mapping type="value-mapping" from="MsgHeader.MesgType" to="products[0].answers.gatewayTransactionId"></mapping><!-- 报文类型代码 -->

  <mapping type="value-mapping" to="paymentMethodInfo.clearingBankCode" from="MsgHeader.OrigSender"/>
  <!--报文发起人 -->
  <mapping type="value-mapping" to="prodCatalogId" from="MsgHeader.OrigSenderSID"/>
  <!--发送系统号 -->
  <mapping type="value-mapping" to="disbursement.clearingBankCode" from="MsgHeader.OrigReceiver"/>
  <!--报文接收人 -->
  <mapping type="value-mapping" to="prodCatalogId" from="MsgHeader.OrigReceiverSID"/>
  <!--接收系统号--> 
  <mapping type="value-mapping" to="products[0].answers.MesgID" from="MsgHeader.MesgID"/>
  <!-- 通信级标识号 -->
  <mapping type="value-mapping" to="products[0].answers.MesgRefID" from="MsgHeader.MesgRefID"/>
  <mapping type="value-mapping" to="isRushOrder" from="MsgHeader.MesgPriority"/>

    <!-- 报文头 end-->

	<!--为方便990添加如下数据 报文类型号本身交流时间和订单一样 同上 -->
	<mapping type="value-mapping" to="extendMap.origSendDate" from="MsgHeader.OrigSendDate"/>
	<mapping type="value-mapping" to="extendMap.mesgID" from="MsgHeader.MesgID"/>
	<mapping type="value-mapping" to="extendMap.mesgRefID" from="MsgHeader.MesgRefID"/>
	<mapping type="value-mapping" to="extendMap.origSenderSID" from="MsgHeader.OrigSenderSID"/>
	<mapping type="value-mapping" to="extendMap.origReceiverSID" from="MsgHeader.OrigReceiverSID"/>
	<mapping type="value-mapping" to="contentMimeTypeId" from="MsgHeader.MesgType"></mapping><!--报文类型号-->
	<mapping type="value-mapping" to="extendMap.origSender" from="MsgHeader.OrigSender"/><!--报文发起人 -->
	<mapping type="value-mapping" to="extendMap.origReceiver" from="MsgHeader.OrigReceiver"/> <!--报文接收人 -->


	<!-- 报文体标识开始 -->
	<mapping type="value-mapping" from="HVPS_112_Out.MessageIdentification" to="products[0].answers.MessageIdentification"></mapping><!-- 报文标识号 -->
	<mapping type="value-mapping" from="HVPS_112_Out.CreationDateTime" to="products[0].answers.CreationDateTime"></mapping><!-- 报文发送时间 -->
	 <!-- 明细业务总笔数 --> <!-- SettlementMethod -->
	<mapping type="value-mapping" from="HVPS_112_Out.EndToEndIdentification" to="transactionId"></mapping><!-- 端到端标识号 -->
	<mapping type="value-mapping" from="HVPS_112_Out.TransactionIdentification" to="products[0].answers.transactionIdentification"></mapping><!-- 交易标识号 -->
	<mapping type="value-mapping" from="HVPS_112_Out.Proprietary" to="operationCategory"></mapping><!-- 业务类型 -->
	<mapping type="value-mapping" from="HVPS_112_Out.CurrencyType" to="currencyUom"></mapping><!-- 币种 -->
	<mapping type="script" to="products[0].quantity" >
	<![CDATA[
		return new java.math.BigDecimal(sourceBean.HVPS_112_Out.InterbankSettlementAmount);
	]]>
	</mapping>
	
	<!-- 货币符号、金额 -->
	<mapping type="value-translate" from="HVPS_112_Out.SettlementPriority" to="isRushOrder">
	 <value from="NORM" to="3" />
    <!--普通-->
    <value from="HIGH" to="2" />
    <!--紧急-->
    <value from="URGT" to="1" />
    <!--特急-->
	</mapping><!-- 业务优先级 -->
	<mapping type="value-mapping" from="HVPS_112_Out.MemberIdentification" to="paymentMethodInfo.clearingBankCode"></mapping><!-- 付款清算行行号 -->
	<mapping type="value-mapping" from="HVPS_112_Out.Identification" to="paymentMethodInfo.bankCode"></mapping><!-- 付款行行号 -->
	<mapping type="value-mapping" from="HVPS_112_Out.MemberIdentification2" to="disbursement.clearingBankCode"></mapping><!-- 收款清算行行号 -->
	<mapping type="value-mapping" from="HVPS_112_Out.Identification2" to="disbursement.bankCode"></mapping><!-- 收款行行号-->
	<!--<mapping type="value-mapping" from="HVPS_112_Out.MemberIdentification3" to="disbursement.acctBankCode"></mapping>--><!-- 中介机构1 -->
	<!--<mapping type="value-mapping" from="HVPS_112_Out.Name" to="disbursement.acctBankName"></mapping>--><!-- 中介机构1名称 -->
	<!--<mapping type="value-mapping" from="HVPS_112_Out.MemberIdentification4" to="disbursement.acctBankCode"></mapping>--><!-- 中介机构2 -->
	<!--<mapping type="value-mapping" from="HVPS_112_Out.Name2" to="disbursement.acctBankName"></mapping>--><!-- 中介机构2名称-->
	<mapping type="value-mapping" from="HVPS_112_Out.Name3" to="paymentMethodInfo.accountName"></mapping><!-- 付款人名称 -->
	<mapping type="value-mapping" from="HVPS_112_Out.AddressLine" to="placingCustomer.address"></mapping><!-- 付款人地址 -->
	<mapping type="value-mapping" from="HVPS_112_Out.Identification3" to="paymentMethodInfo.accountNumber"></mapping><!-- 付款人账号 -->
	<mapping type="value-mapping" from="HVPS_112_Out.MemberIdentification5" to="paymentMethodInfo.acctBankCode"></mapping><!-- 付款人开户行行号 -->
	<mapping type="value-mapping" from="HVPS_112_Out.Name4" to="paymentMethodInfo.acctBankName"></mapping><!-- 付款人开户行名称 -->
	<mapping type="value-mapping" from="HVPS_112_Out.MemberIdentification6" to="disbursement.acctBankCode"></mapping><!-- 收款人开户行行号 -->
	<mapping type="value-mapping" from="HVPS_112_Out.Name5" to="disbursement.acctBankName"></mapping><!-- 收款人开户行名称 -->
	<mapping type="value-mapping" from="HVPS_112_Out.Name6" to="disbursement.accountName"></mapping><!-- 收款人名称 -->
	<mapping type="value-mapping" from="HVPS_112_Out.AddressLine2" to="endUserCustomer.address"></mapping><!-- 收款人地址 -->
	<mapping type="value-mapping" from="HVPS_112_Out.Identification4" to="disbursement.accountNumber"></mapping><!-- 收款人账号 -->
	<mapping type="script" to="products[0].answers.businessType">
	<![CDATA[
			String Unstructured = sourceBean.HVPS_112_Out.Unstructured;
			if(Unstructured != null&&Unstructured.length() > 5){
				Unstructured = Unstructured.substring(5);
				return Unstructured;
			}else{
				return Unstructured;
			}
	]]>
	</mapping><!-- 业务种类编码 
	<mapping type="script" to="internalNote">
	<![CDATA[
			String Unstructured2 = sourceBean.HVPS_112_Out.Unstructured2;
			if(Unstructured2 != null&&Unstructured2.length() > 5){
					Unstructured2 = Unstructured2.substring(5);
					return Unstructured2;
			}else{
				return Unstructured2;
			}
	]]>
	</mapping><备注 --><!--
	<mapping type="script" to="internalNote">
	<![CDATA[
			String Unstructured3 = sourceBean.HVPS_112_Out.Unstructured3;
			if(Unstructured3 != null&&Unstructured3.length() > 5){
					Unstructured3 = Unstructured3.substring(5);
					return Unstructured3;
			}else{
				return Unstructured3;
			}
	]]>
	</mapping> 备注2 
	<mapping type="script" to="products[0].answers.liquidationDate">
	<![CDATA[
			String Unstructured4 = sourceBean.HVPS_112_Out.Unstructured4;
			if(Unstructured4 != null&&Unstructured4.length() > 5){
					Unstructured4 = Unstructured4.substring(5);
					return Unstructured4;
			}else{
				return Unstructured4;
			}
	]]>
	</mapping> 清算日期 -->

	<manual-mapping> <![CDATA[
	import java.util.Map;
	import com.giantstone.cnaps2.messagebean.recv.req.HVPS_112_OutAdditionalList;
	
	List additionalList = sourceBean.HVPS_112_Out.AdditionalList;
	List products = (List)target.get("products");
	Map prodcut = target.get("products").get(0);
	Map answers = prodcut.get("answers");


	//对端到端标识号进行处理，根据业务类型进行处理
		String endToEnd = sourceBean.HVPS_112_Out.EndToEndIdentification;//端到端标识号
		String m3 = sourceBean.HVPS_112_Out.MemberIdentification3;//中介机构1
		String m3Name = sourceBean.HVPS_112_Out.Name;//中介机构1名称
		String m4 = sourceBean.HVPS_112_Out.MemberIdentification4;//中介机构2
		String m4Name = sourceBean.HVPS_112_Out.Name2;//中介机构2名称
		String flag = sourceBean.HVPS_112_Out.Proprietary;//业务类型
		//String flag2 = sourceBean.HVPS_112_Out.Proprietary2;//业务种类
		Map paymentMethodInfo = target.get("paymentMethodInfo");
		Map disbursement = target.get("disbursement");
		
			// 业务类型为“国库资金贷记划拨”(A104)、“票据转贴现”(A117)、“跨境支付”(A113)、行间资金汇划(A200)
			// 如果收款账号为空，收款账号为“0”
			String accountNumber = disbursement.get("accountNumber");
			if(accountNumber == null || "".equals(accountNumber)){
				disbursement.put("accountNumber","0");
			}
			String accountName = disbursement.get("accountName");
			if(accountName == null || "".equals(accountName)){
				disbursement.put("accountName","0");
			}

			accountNumber = paymentMethodInfo.get("accountNumber");
			if(accountNumber == null || "".equals(accountNumber)){
				paymentMethodInfo.put("accountNumber","0");
			}
			accountName = paymentMethodInfo.get("accountName");
			if(accountName == null || "".equals(accountName)){
				paymentMethodInfo.put("accountName","0");
			}

		    //委托收款（划回）、托收承付（划回）、商业汇票、支票、银行汇票、银行本票、城市商业银行汇票
			if("A115".equals(flag)){//再贷款
				if(endToEnd != null){
					paymentMethodInfo.put("voucherNumber",endToEnd);
				}
				
			}else if("A116".equals(flag)){//再贴现
				if(endToEnd != null){
					paymentMethodInfo.put("voucherNumber",endToEnd);
				}
			
			}else if("A113".equals(flag)){//跨境支付   
				if(!"".equals(endToEnd)){
					paymentMethodInfo.put("transactionId",endToEnd);//关联业务参考号,找需求待定
				}
				
				//跨境支付往帐时，中介机构1填“收款人开户行代理行”，中介机构2不填
				if(m3 != null){
					target.put("operationCategory",m3);//中介机构1
				}
				if(m3Name != null){
					target.put("operationCategory",m3Name);//中介机构1名称
				}
				if(m4 != null){
					target.put("operationCategory",m4);//中介机构2
				}
				if(m4Name != null){
					target.put("operationCategory",m4Name);//中介机构2名称
				}
			}

	//退汇中的字段，用在交流事件中
		String originalMessageIdentification = "";//原报文标识号
		String originalInstructingParty = "";//原发起参与机构 
		String originalMessageType = "";// 原报文类型
		String note = "";//退汇原因

		//产品号
		String productId = "";

	//附加域处理
	for(HVPS_112_OutAdditionalList additionalBean : additionalList){
		String tagValue = additionalBean.Ustrd;
		print("tagValue**********"+tagValue);
		String value = null;
		if(tagValue.length()>=5){
			value = tagValue.substring(5);
		}

		//公共附加域
		if(tagValue.contains("F25")){//业务种类
			answers.put("purposeCode", value);

			//拼接产品
			//String paymentType = (String)answers.get("paymentType");
			//String paymentType = sourceBean.HVPS_112_Out.Proprietary;
			//print("answers*********"+answers);
			//String purposeCode = (String)answers.get("purposeCode");
			productId = flag + value;
			prodcut.put("productId", productId);

		}else if(tagValue.contains("H01")){//附言
			answers.put("summary1", value);
		}else if(tagValue.contains("H02")){//附言2
			answers.put("summary2", value);
		}else if(tagValue.contains("C00")){//清算日期
			answers.put("settlementDate", value);

		//A200 行内资金汇划
		}else if(tagValue.contains("D27")){//折借利率
			answers.put("loanInterest", value);
		}else if(tagValue.contains("C28")){//折借期限
			answers.put("loanLimitDate", value);

		//A105 退汇
		}else if(tagValue.contains("E51")){//原报文标识号
			answers.put("externalId", value);
			originalMessageIdentification = value;
		}else if(tagValue.contains("A70")){//原发起参与机构
			answers.put("oldLaunchBankNo", value);
			originalInstructingParty = value;
		}else if(tagValue.contains("F40")){//原报文类型代码
			answers.put("oldMessageType", value);
			originalMessageType = value;
		}else if(tagValue.contains("H20")){//退汇原因
			answers.put("internalNote", value);
			note = value;

		//A113 跨境支付
		}else if(tagValue.contains("C14")){//关联业务委托日期
			answers.put("relatedBussEntrustDate", value);
		}else if(tagValue.contains("F56")){//费用编码
			answers.put("exesCode", value);
		}else if(tagValue.contains("D63")){//发报行的收费
			answers.put("LaunchBankCharges", value);
		}else if(tagValue.contains("D64")){//收报行的收费
			answers.put("payeeBankCharges", value);
		}else if(tagValue.contains("H19")){//跨境业务附言
			answers.put("outerBorderBussSummary", value);
		}else{
			answers.put(tagValue, value);
		}
	}
	
	//拼接附言
	
	String summary1 = (String)answers.get("summary1");
	String summary2 = (String)answers.get("summary2");
	String summary = "";
	if(summary1!=null&&summary2!=null){
		summary = summary1+summary2;
	}else if(summary1!=null){
		summary = summary1;
	}else{
		summary = summary2;
	}
	answers.put("summary", summary);
	prodcut.put("answers",answers);
	// 银行附言
	target.put("internalNote",summary);

	//来帐业务类型为退汇时处理
		if("A105".equals(flag)){
			//修改 serviceId
			target.put("serviceId","processCommunicationEvent,processPaymentOrder");

			//communicationEventTypeId MESSAGE_IN_COMM
			target.put("communicationEventTypeId","MESSAGE_IN_COMM");

			//报文标识号 subject
			String subject = sourceBean.HVPS_112_Out.MessageIdentification;
			target.put("subject",subject);

			//发起参与机构 partyIdFrom
			String partyIdFrom = sourceBean.HVPS_112_Out.Identification;
			target.put("partyIdFrom",partyIdFrom);

			//接收参与机构 partyIdTo
			String partyIdTo = sourceBean.HVPS_112_Out.Identification2;
			target.put("partyIdTo",partyIdTo);

			//报文标识号 messageIdentification
			String messageIdentification = sourceBean.HVPS_112_Out.MessageIdentification;
			target.put("messageIdentification",messageIdentification);

			//接收参与机构 InstructedParty
			String InstructedParty = sourceBean.HVPS_112_Out.Identification2;
			target.put("InstructedParty",InstructedParty);

			//退汇原因 note
			target.put("note",note);
			target.put("internalNote",note);//将退汇原因放到银行附言中，返回给前台
			//产品号
			target.put("productId",productId);

			Map extendMap = target.get("extendMap");

			//原报文标识号 extendMap.originalMessageIdentification
			extendMap.put("originalMessageIdentification",originalMessageIdentification);

			//原发起参与机构 extendMap.originalInstructingParty
			extendMap.put("originalInstructingParty",originalInstructingParty);

			// 原报文类型 extendMap.originalMessageType
			extendMap.put("originalMessageType",originalMessageType);

		}

	]]> </manual-mapping>
</message-bean-mapping>
