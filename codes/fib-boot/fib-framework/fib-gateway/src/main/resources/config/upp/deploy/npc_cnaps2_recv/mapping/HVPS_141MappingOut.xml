<?xml version="1.0" encoding="UTF-8"?>
<message-bean-mapping id="HVPS_141MappingOut" source-type="message-bean" target-type="map">
	  <!--来账登记交流事件要素-->
  	<mapping type="value" to="serviceId">processPaymentOrder</mapping>
	<mapping type="value-mapping" from="checkEscortFlag" to="checkEscortFlag"/> <!--核押验签结果 -->
	<!--来账登记交流事件要素-->
	<mapping type="value" to="salesChannelEnumId">CNAPS</mapping><!--触发ECA条件-->
	<mapping type="value" to="cashOrTallyFlag">1</mapping><!--现转标识-->


	<!--为方便990添加如下数据 报文类型号本身交流时间和订单一样 同上 -->
	<mapping type="value-mapping" to="extendMap.origSendDate" from="MsgHeader.OrigSendDate"/>
	<mapping type="value-mapping" to="extendMap.mesgID" from="MsgHeader.MesgID"/>
	<mapping type="value-mapping" to="extendMap.mesgRefID" from="MsgHeader.MesgRefID"/>
	<mapping type="value-mapping" to="extendMap.origSenderSID" from="MsgHeader.OrigSenderSID"/>
	<mapping type="value-mapping" to="extendMap.origReceiverSID" from="MsgHeader.OrigReceiverSID"/>
	<mapping type="value-mapping" to="contentMimeTypeId" from="MsgHeader.MesgType"></mapping><!--报文类型号-->
	<mapping type="value-mapping" to="extendMap.origSender" from="MsgHeader.OrigSender"/><!--报文发起人 -->
	<mapping type="value-mapping" to="extendMap.origReceiver" from="MsgHeader.OrigReceiver"/> <!--报文接收人 -->
   
	<mapping type="value-mapping" from="MsgHeader.OrigReceiver" to="InstructedParty"></mapping>
	 <!--与平台约定，将报文类型传入answers，方便该业务退汇时确认报文类型-->
	<mapping type="value-mapping" to="products[0].answers.gatewayTransactionId" from="MsgHeader.MesgType"></mapping><!-- 报文类型代码 -->

  <mapping type="value-mapping" to="prodCatalogId" from="MsgHeader.OrigSenderSID"/>
  <!--发送系统号 -->
  <mapping type="value-mapping" to="prodCatalogId" from="MsgHeader.OrigReceiverSID"/>
  <!--接收系统号--> 
  <mapping type="value-mapping" to="products[0].answers.MesgID" from="MsgHeader.MesgID"/>
  <!-- 通信级标识号 -->
  <mapping type="value-mapping" to="products[0].answers.MesgRefID" from="MsgHeader.MesgRefID"/>
  <!-- 报文优先级 -->
  <mapping type="value-mapping" to="isRushOrder" from="MsgHeader.MesgPriority"/>

  <mapping type="value-mapping" from="HVPS_141_Out.MessageIdentification" to="externalId"></mapping><!--报文标识号-->

	

	<!-- 报文头 begin -->
	<mapping type="value-mapping" from="MsgHeader.BeginFlag" to="products[0].answers.BeginFlag"></mapping><!-- 开始标识 -->
	<mapping type="value-mapping" from="MsgHeader.VersionID" to="products[0].answers.VersionID" ></mapping><!--版本 -->
	<mapping type="value-mapping" from="MsgHeader.OrigSender" to="products[0].answers.OrigSender"></mapping><!--报文发起人 -->
	<mapping type="value-mapping" from="MsgHeader.OrigSenderSID" to="products[0].answers.OrigSenderSID"></mapping><!--发送系统号 -->
	<mapping type="value-mapping" from="MsgHeader.OrigReceiver" to="products[0].answers.OrigReceiver"></mapping><!--报文接收人 -->
	<mapping type="value-mapping" from="MsgHeader.OrigReceiverSID" to="products[0].answers.OrigReceiverSID"></mapping><!--接收系统号 -->
	<mapping type="value-mapping" from="MsgHeader.OrigSendDate" to="products[0].answers.OrigSendDate"></mapping><!--报文发起日期 -->
	<mapping type="value-mapping" from="MsgHeader.OrigSendTime" to="products[0].answers.OrigSendTime"></mapping><!--报文发起时间-->
	<mapping type="value-mapping" from="MsgHeader.StructType" to="products[0].answers.StructType"></mapping><!-- 格式类型 -->
	<mapping type="value-mapping" from="MsgHeader.MesgType" to="products[0].answers.MesgType"></mapping><!-- 报文类型代码 -->
	<mapping type="value-mapping" from="MsgHeader.MesgID" to="products[0].answers.MesgID"></mapping><!-- 通信级标识号 -->
	<mapping type="value-mapping" from="MsgHeader.MesgRefID" to="products[0].answers.MesgRefID"></mapping>
  	<mapping type="value-mapping" from="MsgHeader.MesgPriority" to="products[0].answers.MesgPriority"></mapping><!-- 报文优先级-->
	<mapping type="value-mapping" from="MsgHeader.MesgDirection" to="products[0].answers.MesgDirection"></mapping><!--报文传输方向 -->
    <mapping type="value-mapping" from="MsgHeader.Reserve" to="products[0].answers.Reserve"></mapping><!--保留域-->
	<mapping type="value-mapping" from="MsgHeader.EndFlag" to="products[0].answers.EndFlag"></mapping><!-- 结束标识 -->
    <!-- 报文头 end-->

	<!--报文体标识开始-->

	<!-- 报文标识号 -->
	<mapping type="value-mapping" from="HVPS_141_Out.MessageIdentification" to="products[0].answers.MessageIdentification"></mapping>
	<!-- 报文发送时间 -->
	<mapping type="value-mapping" from="HVPS_141_Out.CreationDateTime" to="products[0].answers.CreationDateTime"></mapping>
	<!-- 明细业务总笔数 -->
	<mapping type="value-mapping" from="HVPS_141_Out.NumberOfTransactions" to="products[0].answers.NumberOfTransactions"></mapping>
	<!-- -->
	<mapping type="value-mapping" from="HVPS_141_Out.SettlementMethod" to="products[0].answers.SettlementMethod"></mapping>
	<!-- 特许参与者 -->
	<mapping type="value-mapping" from="HVPS_141_Out.MemberIdentification" to="products[0].answers.MemberIdentification"></mapping>
	<mapping type="value-mapping" from="HVPS_141_Out.MemberIdentification" to="products[0].answers.thirdCreditSender"></mapping>
	<mapping type="value"  to="products[0].answers.thirdCreditFlag">Y</mapping>
	<!-- CNAPS2 -->
	<mapping type="value-mapping" from="HVPS_141_Out.MemberIdentification2" to="products[0].answers.MemberIdentification2"></mapping>
	<!-- 端到端标识号 -->
	<mapping type="value-mapping" from="HVPS_141_Out.EndToEndIdentification" to="products[0].answers.EndToEndIdentification"></mapping>
	<!-- 交易标识号 -->
	<mapping type="value-mapping" from="HVPS_141_Out.TransactionIdentification" to="products[0].answers.TransactionIdentification"></mapping>
	<!-- 业务类型编码 -->
	<mapping type="value-mapping" from="HVPS_141_Out.Proprietary" to="products[0].answers.Proprietary"></mapping>
	<!-- 币种-->
	<mapping type="value-mapping" from="HVPS_141_Out.CurrencyType" to="currencyUom"></mapping>
	<!-- 货币符号、金额 -->
	<mapping type="script" to="products[0].quantity">
	<![CDATA[
		return new java.math.BigDecimal(sourceBean.HVPS_141_Out.InterbankSettlementAmount);
	]]>
	</mapping>
	<mapping type="value-mapping" from="HVPS_141_Out.InterbankSettlementAmount" to="paymentMethodInfo.maxAmount"></mapping>
	<mapping type="value-mapping" from="HVPS_141_Out.InterbankSettlementAmount" to="disbursement.maxAmount"></mapping>
	<!-- 付款清算行行号 -->
	<mapping type="value-mapping" from="HVPS_141_Out.MemberIdentification3" to="paymentMethodInfo.clearingBankCode"></mapping>
	<!-- 付款行行号 -->
	<mapping type="value-mapping" from="HVPS_141_Out.Identification" to="paymentMethodInfo.bankCode"></mapping>
	<!-- 收款清算行行号-->
	<mapping type="value-mapping" from="HVPS_141_Out.MemberIdentification4" to="disbursement.clearingBankCode"></mapping>
	<!-- 收款行行号 -->
	<mapping type="value-mapping" from="HVPS_141_Out.Identification2" to="disbursement.bankCode"></mapping>
	<!-- 付款人名称 -->
	<mapping type="value-mapping" from="HVPS_141_Out.Name" to="paymentMethodInfo.accountName"></mapping>
	<!-- 付款人地址 -->
	<mapping type="value-mapping" from="HVPS_141_Out.AddressLine" to="placingCustomer.address"></mapping>
	<!-- 付款人账号 -->
	<mapping type="value-mapping" from="HVPS_141_Out.Identification3" to="paymentMethodInfo.accountNumber"></mapping>
	<!-- 付款人开户行行号 -->
	<mapping type="value-mapping" from="HVPS_141_Out.MemberIdentification5" to="paymentMethodInfo.clearingBankCode"></mapping>
	<!-- 付款人开户行名称 -->
	<mapping type="value-mapping" from="HVPS_141_Out.Name2" to="paymentMethodInfo.acctBankName"></mapping>
	<!-- 收款人开户行行号 -->
	<mapping type="value-mapping" from="HVPS_141_Out.MemberIdentification6" to="disbursement.clearingBankCode"></mapping>
	<!-- 收款人开户行名称 -->
	<mapping type="value-mapping" from="HVPS_141_Out.Name3" to="disbursement.acctBankName"></mapping>
	<!-- 收款人名称 -->
	<mapping type="value-mapping" from="HVPS_141_Out.Name4" to="disbursement.accountName"></mapping>
	<!-- 收款人地址 -->
	<mapping type="value-mapping" from="HVPS_141_Out.AddressLine2" to="endUserCustomer.address"></mapping>
	<!-- 收款人账号 -->
	<mapping type="value-mapping" from="HVPS_141_Out.Identification4" to="disbursement.accountNumber"></mapping>
	
	<manual-mapping>
<![CDATA[
		import java.util.Map;
		import java.util.ArrayList;
		import java.util.List;
		import java.util.HashMap;
		import com.giantstone.cnaps2.messagebean.recv.req.HVPS_141_OutHvps;
		
		List ccti = sourceBean.HVPS_141_Out.hvps;
		
		List products = target.get("products");	

		String productId = "";//产品id

		String operType = sourceBean.HVPS_141_Out.Proprietary;
		
		Map map = (Map)products.get(0);
			
		Map answers = map.get("answers");

		Map paymentMethodInfo = target.get("paymentMethodInfo");
		Map disbursement = target.get("disbursement");
		Map extendMap = target.get("extendMap");
		// 如果收款账号为空，收款账号为“0”
		String accountNumber = disbursement.get("accountNumber");
		if(accountNumber == null || "".equals(accountNumber)){
			disbursement.put("accountNumber","0");
		}
		String accountName = disbursement.get("accountName");
		if(accountName == null || "".equals(accountName)){
			disbursement.put("accountName","0");
		}

		accountNumber = paymentMethodInfo.get("accountNumber");
		if(accountNumber == null || "".equals(accountNumber)){
			paymentMethodInfo.put("accountNumber","0");
		}
		accountName = paymentMethodInfo.get("accountName");
		if(accountName == null || "".equals(accountName)){
			paymentMethodInfo.put("accountName","0");
		}
		
		String str1 = "";//为了将附言和附言2合并
		for(HVPS_141_OutHvps hvps141Ccti : ccti){
			
			String value = hvps141Ccti.Ustrd;
			String name = "";
			if(value.contains("F25")){
				name="businessType";//业务种类编码
				productId = operType+value.substring(5);
			}else if(value.contains("E48")){
				name="transactionBatchId";//交易批次号
			}else if(value.contains("F31")){
				name="DCFlag";// 借贷标识  借记DBIT 贷记DEBT
				String flag = value.substring(5);
				if("DBIT".equals(flag)){//DEBT
					extendMap.put("dcFlag", "D"); // 收付款方都是本行时，判重时需要
					disbursement.put("paymentMethodTypeId","EXT_CNAPS");
					disbursement.put("paymentMethodId","10001");
					paymentMethodInfo.put("voucherType","4099");
					
					// Modify by zhao_dl 20141129 start，行方需求即时转账业务直接记内部账
					//target.put("paymentOrderStepSettingId","SKIP_PAYMENT");
					// Modify by zhao_dl 20141129 end
					
					//paymentOrderStepSettingId="SKIP_PAYMENT" 跳过支付环节,可能没有付款人账户
					String messageId = sourceBean.HVPS_141_Out.MessageIdentification;//报文标识号，第三方及时转账DBIT时，不交付
					disbursement.put("manualRefNum", messageId);//对于借记，交付方支付工具以EXT_开头，程序要发报，
																//但是业务不需要发报，故配置人工认证号，方可不发报
					
					// Add by zhao_dl 20141129 start，行方需求即时转账业务直接记内部账
					paymentMethodInfo.put("accountNumber", "99990140209999990088"); // 账号
					paymentMethodInfo.put("accountName", "四川银行凉山分行股份有限公司"); // 户名
					// Add by zhao_dl 20141129 end 
					
				}else{
					extendMap.put("dcFlag", "C"); // 收付款方都是本行时，判重时需要
					paymentMethodInfo.put("paymentMethodTypeId","EXT_CNAPS");
					paymentMethodInfo.put("paymentMethodId","10001");
					//人工认证号
					paymentMethodInfo.put("manualRefNum", sourceBean.HVPS_141_Out.MessageIdentification);
					disbursement.put("voucherType","4099");
					
					// Add by zhao_dl 20141129 start，行方需求即时转账业务直接记内部账
					disbursement.put("accountNumber", "99990140209999990088"); // 账号
					disbursement.put("accountName", "四川银行凉山分行股份有限公司"); // 户名
					// Add by zhao_dl 20141129 end 
				}
			}else if(value.contains("H01")){
				str1 = value.substring(5);
				name="remark";//备注
				target.put("publicNote",str1);
			}else if(value.contains("H02")){
				str1+=value.substring(5);
				name="remark2";// 备注2
				target.put("publicNote",str1);
			}else if(value.contains("C00")){
				name="settlementDate";//清算日期
			}else if(value.contains("E40")){
				name="bondNo";//债券/央票代码
			}else if(value.contains("D14")){
				name="bondParValue";//债券/央票面额
			}else if(value.contains("D32")){
				name="netPriceAmount";//净价金额
			}else if(value.contains("D33")){
				name="bondInterest";//债券/央票利息
			}else if(value.contains("D11")){
				name="firstBuyAmount";//回购首期结算额
			}else if(value.contains("D34")){
				name="interest";// 回购利息
			}else if(value.contains("C19")){
				name="buyFallinDate";//回购到期日
			}else if(value.contains("F58")){
				name="foreignExchangeCurrency";//外汇交易币种
			}else if(value.contains("D35")){
				name="depositBonusTotal";// 质押债券总面额
			}else if(value.contains("A07")){
				name="outNo";// 出质行行号
			}else if(value.contains("E50")){
				name="oldMessageIdentifier";//原报文标识号
			}else if(value.contains("A70")){
				name="oldLaunchBankNo";//原发起参与机构
			}else if(value.contains("F60")){
				name="processCode";//业务状态
			}else if(value.contains("D36")){
				name="financingPrincipal";// 融资本金
			}else if(value.contains("D37")){
				name="financingInterest";//融资利息
			}else if(value.contains("F59")){
				name="refundType";//还款类型
			}else if(value.contains("E39")){
				name="agreementId";// 业务协议号
			}else if(value.contains("F50")){
				name="moneyPMFlag";//金额正负标识
			}else if(value.contains("F61")){
				name="operationStatus";//业务状态
			}
			
			String valueSub = value.substring(5);
			answers.put(name,valueSub);	
		}
		map.put("productId",productId);
		print(target);
		

	]]>
	</manual-mapping>
</message-bean-mapping>
